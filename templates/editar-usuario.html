<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SafeVest - Editar Usu√°rio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="d-flex" id="wrapper">
        <div id="sidebar-wrapper"></div>
        <div id="page-content-wrapper">
            <!-- Navbar -->
            <nav class="d-flex align-items-center justify-content-between bg-danger text-white p-3 shadow-sm">
                <div class="d-flex gap-3 align-items-center">
                    <a href="#" class="text-white fs-4" id="menu-toggle">
                        <i class="bi bi-list"></i>
                    </a>
                    <span class="fs-5 fw-bold">Editar Usu√°rio</span>
                </div>
                <a href="/templates/trabalhadores.html" class="btn btn-light btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>
                    Voltar
                </a>
            </nav>

            <!-- Main -->
            <main class="container-fluid my-4">
                <div class="row justify-content-center">
                    <div class="col-lg-10">
                        <!-- Loading -->
                        <div id="loading-container" class="text-center py-5">
                            <div class="spinner-border text-danger" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="text-muted mt-3">Carregando dados do usu√°rio...</p>
                        </div>

                        <!-- Formul√°rio (escondido inicialmente) -->
                        <div id="form-container" class="d-none">
                            <div class="card shadow-sm border-0">
                                <div class="card-body p-4 p-md-5">
                                    <h5 class="card-title mb-3">Editar Colaborador</h5>
                                    <p class="card-text text-muted mb-4">
                                        Atualize os dados do colaborador. Campos marcados com * s√£o obrigat√≥rios.
                                    </p>

                                    <form id="form-editar-usuario">
                                        <!-- Nome e Sobrenome -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="first_name" class="form-label">Nome *</label>
                                                <input type="text" class="form-control" id="first_name" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="last_name" class="form-label">Sobrenome *</label>
                                                <input type="text" class="form-control" id="last_name" required>
                                            </div>
                                        </div>

                                        <!-- Email -->
                                        <div class="mb-3">
                                            <label for="email" class="form-label">Email (Login) *</label>
                                            <input type="email" class="form-control" id="email" required>
                                            <small class="form-text text-muted">
                                                Este √© o email usado para login no sistema.
                                            </small>
                                        </div>

                                        <!-- Fun√ß√£o -->
                                        <div class="mb-3">
                                            <label for="funcao" class="form-label">Fun√ß√£o *</label>
                                            <select class="form-select" id="funcao" required>
                                                <option value="">Selecione...</option>
                                                <option value="Administrador">Administrador</option>
                                                <option value="Supervisor">Supervisor</option>
                                                <option value="Operador">Operador</option>
                                            </select>
                                        </div>

                                        <!-- Status Ativo/Inativo -->
                                        <div class="mb-4">
                                            <label class="form-label">Status do Usu√°rio *</label>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="ativo" checked>
                                                <label class="form-check-label" for="ativo" id="status-label">
                                                    Usu√°rio Ativo
                                                </label>
                                            </div>
                                            <small class="form-text text-muted">
                                                Usu√°rios inativos n√£o podem acessar o sistema.
                                            </small>
                                        </div>

                                        <!-- Feedback -->
                                        <div id="feedback-alert" class="alert d-none" role="alert"></div>

                                        <!-- Bot√µes -->
                                        <div class="d-flex gap-2 justify-content-end mt-4">
                                            <a href="/templates/trabalhadores.html" class="btn btn-secondary">
                                                <i class="bi bi-x-circle me-1"></i>
                                                Cancelar
                                            </a>
                                            <button type="submit" class="btn btn-danger">
                                                <span class="spinner-border spinner-border-sm d-none" id="spinner"></span>
                                                <i class="bi bi-check-circle me-1"></i>
                                                <span id="btn-text">Salvar Altera√ß√µes</span>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/layout.js"></script>

    <script>
        console.log("üü¢ [EDITAR] Script carregado");

        const API_BASE = "http://127.0.0.1:8000/api";
        let userId = null;

        // ============== AUTENTICA√á√ÉO ==============
        function getTokens() {
            return {
                access: localStorage.getItem("accessToken"),
                refresh: localStorage.getItem("refreshToken"),
            };
        }

        function logout() {
            localStorage.removeItem("accessToken");
            localStorage.removeItem("refreshToken");
            window.location.href = "/templates/login.html";
        }

        async function refreshToken() {
            const { refresh } = getTokens();
            if (!refresh) return false;

            try {
                const resp = await fetch(`${API_BASE}/token/refresh/`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ refresh }),
                });

                if (!resp.ok) return false;

                const data = await resp.json();
                localStorage.setItem("accessToken", data.access);
                return true;
            } catch (err) {
                console.error("‚ùå [AUTH] Erro ao renovar token:", err);
                return false;
            }
        }

        async function fetchWithAuth(url, options = {}, retry = true) {
            const { access } = getTokens();

            if (!access) {
                alert("Sess√£o expirada. Fa√ßa login novamente.");
                logout();
                return null;
            }

            const headers = {
                "Content-Type": "application/json",
                Authorization: `Bearer ${access}`,
                ...options.headers,
            };

            try {
                const resp = await fetch(url, { ...options, headers });

                if (resp.status === 401 && retry) {
                    const renovado = await refreshToken();
                    if (renovado) return fetchWithAuth(url, options, false);
                    logout();
                    return null;
                }

                return resp;
            } catch (err) {
                console.error("üí• [FETCH] Erro:", err);
                throw err;
            }
        }

        // ============== UTILIT√ÅRIOS ==============
        function showAlert(message, type = "warning") {
            const feedback = document.getElementById("feedback-alert");
            feedback.textContent = message;
            feedback.className = `alert alert-${type}`;
            feedback.classList.remove("d-none");
        }

        function hideAlert() {
            document.getElementById("feedback-alert").classList.add("d-none");
        }

        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // ============== CARREGAR DADOS ==============
        async function carregarUsuario() {
            const params = new URLSearchParams(window.location.search);
            userId = params.get("id");

            if (!userId) {
                showAlert("ID do usu√°rio n√£o fornecido na URL.", "danger");
                document.getElementById("loading-container").innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        ID do usu√°rio n√£o fornecido.
                        <a href="/templates/trabalhadores.html" class="btn btn-danger btn-sm ms-3">Voltar</a>
                    </div>
                `;
                return;
            }

            try {
                console.log("[EDITAR] Carregando usu√°rio ID:", userId);

                const resp = await fetchWithAuth(`${API_BASE}/usuarios/${userId}/`);
                
                if (!resp) {
                    throw new Error("Sem resposta do servidor");
                }

                console.log("[EDITAR] Status da resposta:", resp.status);

                if (!resp.ok) {
                    // Tenta ler o erro do backend
                    const errorText = await resp.text();
                    console.error("[EDITAR] Erro do backend:", errorText);
                    
                    if (resp.status === 500) {
                        throw new Error("Erro interno no servidor. Verifique os logs do Django.");
                    } else if (resp.status === 404) {
                        throw new Error("Usu√°rio n√£o encontrado.");
                    } else if (resp.status === 403) {
                        throw new Error("Voc√™ n√£o tem permiss√£o para visualizar este usu√°rio.");
                    } else {
                        throw new Error(`Erro ${resp.status}: ${errorText}`);
                    }
                }

                const usuario = await resp.json();
                console.log("[EDITAR] Dados recebidos:", usuario);

                // Preenche formul√°rio com valores seguros
                document.getElementById("first_name").value = usuario.first_name || usuario.nome?.split(' ')[0] || "";
                document.getElementById("last_name").value = usuario.last_name || usuario.nome?.split(' ').slice(1).join(' ') || "";
                document.getElementById("email").value = usuario.email || "";
                document.getElementById("funcao").value = usuario.funcao || usuario.groups?.[0] || "";
                
                // Trata diferentes formatos de "ativo"
                let isAtivo = true; // default
                if (usuario.ativo !== undefined) {
                    isAtivo = usuario.ativo;
                } else if (usuario.profile?.ativo !== undefined) {
                    isAtivo = usuario.profile.ativo;
                }
                document.getElementById("ativo").checked = isAtivo;

                // Atualiza label do status
                updateStatusLabel();

                // Mostra formul√°rio e esconde loading
                document.getElementById("loading-container").classList.add("d-none");
                document.getElementById("form-container").classList.remove("d-none");

            } catch (error) {
                console.error("[EDITAR] Erro ao carregar:", error);
                document.getElementById("loading-container").innerHTML = `
                    <div class="alert alert-danger">
                        <h4><i class="bi bi-exclamation-triangle me-2"></i>Erro ao Carregar Dados</h4>
                        <p class="mb-3">${error.message}</p>
                        <div class="alert alert-warning">
                            <strong>Dica para Debug:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Abra o terminal do Django e veja o erro completo</li>
                                <li>Verifique se o usu√°rio ID ${userId} existe no banco</li>
                                <li>Teste o endpoint diretamente: <code>GET /api/usuarios/${userId}/</code></li>
                            </ul>
                        </div>
                        <a href="/templates/trabalhadores.html" class="btn btn-danger mt-2">
                            <i class="bi bi-arrow-left me-1"></i> Voltar para Lista
                        </a>
                    </div>
                `;
            }
        }

        // ============== ATUALIZAR LABEL STATUS ==============
        function updateStatusLabel() {
            const checkbox = document.getElementById("ativo");
            const label = document.getElementById("status-label");
            
            if (checkbox.checked) {
                label.textContent = "Usu√°rio Ativo";
                label.className = "form-check-label text-success fw-bold";
            } else {
                label.textContent = "Usu√°rio Inativo";
                label.className = "form-check-label text-danger fw-bold";
            }
        }

        // ============== SUBMIT ==============
        document.addEventListener("DOMContentLoaded", async () => {
            await carregarUsuario();

            // Toggle status label
            document.getElementById("ativo")?.addEventListener("change", updateStatusLabel);

            // Submit form
            const form = document.getElementById("form-editar-usuario");
            form?.addEventListener("submit", async (e) => {
                e.preventDefault();
                console.log("[SUBMIT] Formul√°rio enviado");
                hideAlert();

                const firstName = document.getElementById("first_name").value.trim();
                const lastName = document.getElementById("last_name").value.trim();
                const email = document.getElementById("email").value.trim();
                const funcao = document.getElementById("funcao").value;
                const ativo = document.getElementById("ativo").checked;

                // Valida√ß√µes
                if (!firstName) return showAlert("Informe o nome.", "warning");
                if (!lastName) return showAlert("Informe o sobrenome.", "warning");
                if (!validateEmail(email)) return showAlert("Email inv√°lido.", "warning");
                if (!funcao) return showAlert("Selecione uma fun√ß√£o.", "warning");

                // Desabilita bot√£o
                const submitBtn = form.querySelector('button[type="submit"]');
                const spinner = document.getElementById("spinner");
                const btnText = document.getElementById("btn-text");
                
                submitBtn.disabled = true;
                spinner.classList.remove("d-none");
                btnText.textContent = "Salvando...";

                const payload = {
                    first_name: firstName,
                    last_name: lastName,
                    email,
                    funcao,
                    ativo
                };

                console.log("[PAYLOAD]:", payload);

                try {
                    const resp = await fetchWithAuth(`${API_BASE}/usuarios/${userId}/`, {
                        method: "PATCH",
                        body: JSON.stringify(payload)
                    });

                    if (!resp) return;

                    if (resp.ok) {
                        const data = await resp.json();
                        console.log("[SUCCESS]:", data);
                        
                        showAlert("Usu√°rio atualizado com sucesso!", "success");
                        
                        setTimeout(() => {
                            window.location.href = "/templates/trabalhadores.html";
                        }, 1500);
                    } else {
                        const error = await resp.json().catch(() => ({}));
                        console.error("[ERROR]:", error);
                        
                        let msg = error.erro || error.detail || "Erro ao atualizar usu√°rio.";
                        
                        if (resp.status === 400 && error.email) {
                            msg = "Este email j√° est√° em uso por outro usu√°rio.";
                        }
                        if (resp.status === 403) {
                            msg = "Voc√™ n√£o tem permiss√£o para editar usu√°rios.";
                        }
                        
                        showAlert(msg, "danger");
                    }
                } catch (error) {
                    console.error("[EXCEPTION]:", error);
                    showAlert("Erro de rede: " + error.message, "danger");
                } finally {
                    submitBtn.disabled = false;
                    spinner.classList.add("d-none");
                    btnText.textContent = "Salvar Altera√ß√µes";
                }
            });

            console.log("‚úÖ [READY] Script de edi√ß√£o pronto!");
        });
    </script>
</body>
</html>