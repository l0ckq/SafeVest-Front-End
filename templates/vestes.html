<!doctype html>
<html lang="pt-br">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>SafeVest - Gerenciar Vestes</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/static/css/style.css">
    </head>
    <body>
        <div class="d-flex" id="wrapper">
            <div id="sidebar-wrapper"></div>
            <div id="page-content-wrapper">
                <nav class="d-flex align-items-center justify-content-between bg-danger text-white p-3 shadow-sm">
                    <div class="d-flex gap-3 align-items-center">
                        <a href="#" class="text-white fs-4" id="menu-toggle">
                            <i class="bi bi-list"></i>
                        </a>
                        <span class="fs-5 fw-bold">Gerenciamento de Vestes</span>
                    </div>
                    <a href="/templates/cadastrar-vestes.html" class="btn btn-light btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>
                        Adicionar Vestes
                    </a>
                </nav>
                <main class="container-fluid my-4">
                    <!-- Filtros -->
                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <div>
                            <strong class="me-3">Filtrar por:</strong>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-secondary active" data-filter="todas">Todas</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-filter="disponiveis">Dispon√≠veis</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-filter="em-uso">Em Uso</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-filter="indisponiveis">Indispon√≠veis</button>
                            </div>
                        </div>
                        <div>
                            <span class="text-muted" id="contador-vestes">Carregando...</span>
                        </div>
                    </div>

                    <!-- Tabela -->
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">Serial das SafeVests</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Associa√ß√£o</th>
                                    <th scope="col">Usu√°rio</th>
                                    <th scope="col">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="vestes-table-body">
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="spinner-border text-danger" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </main>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/static/js/layout.js"></script>

        <script>
            console.log("üü¢ [VESTES] Script carregado");

            const API_BASE = "http://127.0.0.1:8000/api";
            let todasAsVestes = [];

            // ============== AUTENTICA√á√ÉO ==============
            function getTokens() {
                return {
                    access: localStorage.getItem("accessToken"),
                    refresh: localStorage.getItem("refreshToken"),
                };
            }

            function logout() {
                localStorage.removeItem("accessToken");
                localStorage.removeItem("refreshToken");
                window.location.href = "/templates/login.html";
            }

            async function refreshToken() {
                const { refresh } = getTokens();
                if (!refresh) return false;

                try {
                    const resp = await fetch(`${API_BASE}/token/refresh/`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ refresh }),
                    });

                    if (!resp.ok) return false;

                    const data = await resp.json();
                    localStorage.setItem("accessToken", data.access);
                    return true;
                } catch (err) {
                    console.error("‚ùå [AUTH] Erro ao renovar token:", err);
                    return false;
                }
            }

            async function fetchWithAuth(url, options = {}, retry = true) {
                const { access } = getTokens();

                if (!access) {
                    alert("Sess√£o expirada. Fa√ßa login novamente.");
                    logout();
                    return null;
                }

                const headers = {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${access}`,
                    ...options.headers,
                };

                try {
                    const resp = await fetch(url, { ...options, headers });

                    if (resp.status === 401 && retry) {
                        const renovado = await refreshToken();
                        if (renovado) return fetchWithAuth(url, options, false);
                        logout();
                        return null;
                    }

                    return resp;
                } catch (err) {
                    console.error("üí• [FETCH] Erro:", err);
                    throw err;
                }
            }

            // ============== RENDERIZA√á√ÉO ==============
            function renderVestes(listaDeVestes) {
                const tableBody = document.querySelector('#vestes-table-body');
                const contador = document.querySelector('#contador-vestes');

                if (!tableBody) return;
                tableBody.innerHTML = '';

                // Atualiza contador
                contador.textContent = `${listaDeVestes.length} veste(s) encontrada(s)`;

                if (listaDeVestes.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Nenhuma veste encontrada.</td></tr>';
                    return;
                }

                listaDeVestes.forEach(veste => {
                    const row = document.createElement('tr');
                    
                    // Verifica status e associa√ß√£o
                    const estaAtiva = veste.status === 'ativa';
                    const temProfile = veste.profile && veste.profile !== null;
                    const estaDisponivel = estaAtiva && !temProfile;
                    
                    // Badge de status da veste (ativa/inativa)
                    const statusVeste = estaAtiva
                        ? '<span class="badge bg-success">Ativa</span>' 
                        : '<span class="badge bg-secondary">Inativa</span>';
                    
                    // Badge de disponibilidade (l√≥gica corrigida)
                    let statusAssociacao;
                    if (!estaAtiva) {
                        // Se inativa, sempre indispon√≠vel
                        statusAssociacao = '<span class="badge bg-danger">Indispon√≠vel</span>';
                    } else if (temProfile) {
                        // Se ativa e tem profile, em uso
                        statusAssociacao = '<span class="badge bg-primary">Em Uso</span>';
                    } else {
                        // Se ativa e sem profile, dispon√≠vel
                        statusAssociacao = '<span class="badge bg-success">Dispon√≠vel</span>';
                    }
                    
                    // Nome do usu√°rio
                    let nomeUsuario = '<span class="text-muted">‚Äî</span>';
                    if (temProfile) {
                        if (veste.profile.user) {
                            nomeUsuario = veste.profile.user.first_name || veste.profile.user.username || 'Usu√°rio';
                        } else if (veste.profile.nome) {
                            nomeUsuario = veste.profile.nome;
                        }
                    }

                    row.innerHTML = `
                        <td class="fw-bold font-monospace">${veste.numero_de_serie}</td>
                        <td>${statusVeste}</td>
                        <td>${statusAssociacao}</td>
                        <td>${nomeUsuario}</td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                ${estaDisponivel ? `
                                    <button class="btn btn-outline-primary associar-btn" data-id="${veste.id}" data-serial="${veste.numero_de_serie}" title="Associar usu√°rio">
                                        <i class="bi bi-person-plus"></i>
                                    </button>
                                ` : temProfile && estaAtiva ? `
                                    <button class="btn btn-outline-warning desassociar-btn" data-id="${veste.id}" data-serial="${veste.numero_de_serie}" title="Desassociar usu√°rio">
                                        <i class="bi bi-person-dash"></i>
                                    </button>
                                ` : `
                                    <button class="btn btn-outline-secondary" disabled title="Indispon√≠vel para associa√ß√£o">
                                        <i class="bi bi-slash-circle"></i>
                                    </button>
                                `}
                                <button class="btn btn-outline-danger excluir-btn" data-id="${veste.id}" data-serial="${veste.numero_de_serie}" title="Excluir veste">
                                    <i class="bi bi-trash3"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                // Registra eventos
                registrarEventos();
            }

            function registrarEventos() {
                // Bot√µes de associar
                document.querySelectorAll('.associar-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.dataset.id;
                        const serial = btn.dataset.serial;
                        window.location.href = `/templates/associar-veste.html?id=${id}&serial=${serial}`;
                    });
                });

                // Bot√µes de desassociar
                document.querySelectorAll('.desassociar-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const id = btn.dataset.id;
                        const serial = btn.dataset.serial;
                        if (confirm(`Desassociar veste ${serial}?`)) {
                            await desassociarVeste(id);
                        }
                    });
                });

                // Bot√µes de excluir
                document.querySelectorAll('.excluir-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const id = btn.dataset.id;
                        const serial = btn.dataset.serial;
                        if (confirm(`Tem certeza que deseja EXCLUIR a veste ${serial}?`)) {
                            await excluirVeste(id);
                        }
                    });
                });
            }

            // ============== A√á√ïES ==============
            async function desassociarVeste(id) {
                try {
                    const resp = await fetchWithAuth(`${API_BASE}/veste/${id}/`, {
                        method: 'PATCH',
                        body: JSON.stringify({ profile: null })
                    });

                    if (resp && resp.ok) {
                        alert('Veste desassociada com sucesso!');
                        fetchVestes();
                    } else {
                        alert('Erro ao desassociar veste.');
                    }
                } catch (error) {
                    console.error('Erro ao desassociar:', error);
                    alert('Erro de rede.');
                }
            }

            async function excluirVeste(id) {
                try {
                    const resp = await fetchWithAuth(`${API_BASE}/veste/${id}/`, {
                        method: 'DELETE'
                    });

                    if (resp && resp.ok) {
                        alert('Veste exclu√≠da com sucesso!');
                        fetchVestes();
                    } else {
                        alert('Erro ao excluir veste.');
                    }
                } catch (error) {
                    console.error('Erro ao excluir:', error);
                    alert('Erro de rede.');
                }
            }

            // ============== BUSCAR VESTES ==============
            async function fetchVestes() {
                try {
                    console.log("üì° [FETCH] Buscando vestes...");
                    const resp = await fetchWithAuth(`${API_BASE}/veste/`);

                    if (!resp || !resp.ok) {
                        throw new Error('Erro ao buscar vestes');
                    }

                    const data = await resp.json();
                    console.log("üìÑ [VESTES] Dados recebidos:", data);

                    // Adapta para diferentes formatos
                    todasAsVestes = Array.isArray(data) ? data : (data.results || []);
                    
                    renderVestes(todasAsVestes);
                } catch (error) {
                    console.error("‚ùå [ERROR] Erro ao buscar vestes:", error);
                    const tableBody = document.querySelector('#vestes-table-body');
                    if (tableBody) {
                        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Falha ao carregar dados. Verifique a conex√£o.</td></tr>';
                    }
                }
            }

            // ============== FILTROS ==============
            document.addEventListener('DOMContentLoaded', () => {
                // Busca inicial
                fetchVestes();

                // Bot√µes de filtro
                const filterButtons = document.querySelectorAll('.btn-group .btn');
                filterButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        filterButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');

                        const filterType = button.dataset.filter;
                        let vestesFiltradas = [];

                        if (filterType === 'todas') {
                            vestesFiltradas = todasAsVestes;
                        } else if (filterType === 'disponiveis') {
                            // Dispon√≠veis: ativas E sem profile
                            vestesFiltradas = todasAsVestes.filter(v => 
                                v.status === 'ativa' && v.profile === null
                            );
                        } else if (filterType === 'em-uso') {
                            // Em uso: ativas E com profile
                            vestesFiltradas = todasAsVestes.filter(v => 
                                v.status === 'ativa' && v.profile !== null
                            );
                        } else if (filterType === 'indisponiveis') {
                            // Indispon√≠veis: inativas (com ou sem profile)
                            vestesFiltradas = todasAsVestes.filter(v => 
                                v.status === 'inativo'
                            );
                        }
                        
                        renderVestes(vestesFiltradas);
                    });
                });

                console.log("‚úÖ [READY] Script de vestes pronto!");
            });
        </script>
    </body>
</html>