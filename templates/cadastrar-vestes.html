<!doctype html>
<html lang="pt-br">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>SafeVest - Cadastrar Vestes</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/static/css/style.css">
    </head>
    <body>
        <div class="d-flex" id="wrapper">
            <div id="sidebar-wrapper"></div>
            <div id="page-content-wrapper">
                <nav class="d-flex align-items-center justify-content-between bg-danger text-white p-3 shadow-sm">
                    <div class="d-flex gap-3 align-items-center">
                        <a href="#" class="text-white fs-4" id="menu-toggle">
                            <i class="bi bi-list"></i>
                        </a>
                        <span class="fs-5 fw-bold">Cadastrar Vestes</span>
                    </div>
                    <a href="/templates/vestes.html" class="btn btn-light btn-sm">
                        <i class="bi bi-arrow-left me-1"></i>
                        Voltar
                    </a>
                </nav>
                <main class="container-fluid my-4">
                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                            <div class="card shadow-sm">
                                <div class="card-body p-4">
                                    <h5 class="card-title mb-3">Cadastro em Lote de SafeVests</h5>
                                    <p class="card-text text-muted">
                                        Cole ou digite os n√∫meros de s√©rie das vestes no campo abaixo, <strong>um por linha</strong>. 
                                        O sistema ir√° criar apenas as vestes que ainda n√£o existem.
                                    </p>
                                    
                                    <form id="form-cadastro-vestes">
                                        <!-- Status Padr√£o -->
                                        <div class="mb-3">
                                            <label for="status-padrao" class="form-label fw-semibold">
                                                <i class="bi bi-toggle-on me-1"></i>
                                                Status Padr√£o das Vestes
                                            </label>
                                            <select class="form-select" id="status-padrao" required>
                                                <option value="ativa" selected>Ativa</option>
                                                <option value="inativo">Inativo</option>
                                            </select>
                                            <small class="form-text text-muted">
                                                Todas as vestes ser√£o criadas com este status.
                                            </small>
                                        </div>

                                        <!-- N√∫meros de S√©rie -->
                                        <div class="mb-3">
                                            <label for="seriais-input" class="form-label fw-semibold">
                                                <i class="bi bi-shield-check me-1"></i>
                                                N√∫meros de S√©rie
                                            </label>
                                            <textarea
                                                class="form-control font-monospace"
                                                id="seriais-input"
                                                rows="12"
                                                placeholder="SV-DEMO-01&#10;SV-DEMO-02&#10;SV-DEMO-03&#10;SV-DEMO-04&#10;SV-DEMO-05"
                                                required
                                            ></textarea>
                                            <small class="form-text text-muted">
                                                Digite um n√∫mero de s√©rie por linha. Espa√ßos e letras min√∫sculas ser√£o automaticamente corrigidos.
                                            </small>
                                        </div>

                                        <!-- Bot√£o -->
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-danger">
                                                <span class="spinner-border spinner-border-sm d-none" id="spinner" role="status"></span>
                                                <i class="bi bi-plus-circle me-1"></i>
                                                Cadastrar Vestes
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" id="btn-limpar">
                                                <i class="bi bi-trash me-1"></i>
                                                Limpar
                                            </button>
                                        </div>
                                    </form>

                                    <!-- Feedback -->
                                    <div id="feedback-container" class="mt-4 d-none">
                                        <hr>
                                        <h6><i class="bi bi-clipboard-check me-2"></i>Resultado do Processamento</h6>
                                        <div id="feedback-alert" class="alert" role="alert"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/static/js/layout.js"></script>

        <script>
            console.log("üü¢ [VESTES] Script carregado");

            document.addEventListener('DOMContentLoaded', () => {
                const API_BASE = "http://127.0.0.1:8000/api";
                const form = document.querySelector('#form-cadastro-vestes');
                const textArea = document.querySelector('#seriais-input');
                const statusSelect = document.querySelector('#status-padrao');
                const submitButton = form.querySelector('button[type="submit"]');
                const spinner = document.querySelector('#spinner');
                const feedbackContainer = document.querySelector('#feedback-container');
                const feedbackAlert = document.querySelector('#feedback-alert');
                const contadorTexto = document.querySelector('#contador-texto');
                const btnLimpar = document.querySelector('#btn-limpar');

                // Autentica√ß√£o
                function getTokens() {
                    return {
                        access: localStorage.getItem("accessToken"),
                        refresh: localStorage.getItem("refreshToken"),
                    };
                }

                function logout() {
                    localStorage.removeItem("accessToken");
                    localStorage.removeItem("refreshToken");
                    window.location.href = "/templates/login.html";
                }

                async function refreshToken() {
                    const { refresh } = getTokens();
                    if (!refresh) return false;

                    try {
                        const resp = await fetch(`${API_BASE}/token/refresh/`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ refresh }),
                        });

                        if (!resp.ok) return false;

                        const data = await resp.json();
                        localStorage.setItem("accessToken", data.access);
                        return true;
                    } catch (err) {
                        console.error("‚ùå [AUTH] Erro ao renovar token:", err);
                        return false;
                    }
                }

                async function fetchWithAuth(url, options = {}, retry = true) {
                    const { access } = getTokens();

                    if (!access) {
                        alert("Sess√£o expirada. Fa√ßa login novamente.");
                        logout();
                        return null;
                    }

                    const headers = {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${access}`,
                        ...options.headers,
                    };

                    try {
                        const resp = await fetch(url, { ...options, headers });

                        if (resp.status === 401 && retry) {
                            const renovado = await refreshToken();
                            if (renovado) return fetchWithAuth(url, options, false);
                            logout();
                            return null;
                        }

                        return resp;
                    } catch (err) {
                        console.error("üí• [FETCH] Erro:", err);
                        throw err;
                    }
                }

                // Normaliza serial (remove espa√ßos e coloca em mai√∫scula)
                function normalizeSerial(s) {
                    return s.replace(/\s+/g, '').toUpperCase();
                }

                // Bot√£o limpar
                btnLimpar.addEventListener('click', () => {
                    textArea.value = '';
                    feedbackContainer.classList.add('d-none');
                });

                // Submit
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log("üöÄ [SUBMIT] Formul√°rio enviado");
                    feedbackContainer.classList.add('d-none');

                    const textoSeriais = textArea.value;
                    const status = statusSelect.value; // ‚Üê Agora pega 'ativa' ou 'inativo'

                    if (!textoSeriais || !textoSeriais.trim()) {
                        feedbackAlert.className = 'alert alert-warning';
                        feedbackAlert.textContent = 'Por favor, insira ao menos um n√∫mero de s√©rie.';
                        feedbackContainer.classList.remove('d-none');
                        return;
                    }

                    let lista = textoSeriais.split('\n')
                        .map(s => s.trim())
                        .filter(s => s.length > 0)
                        .map(normalizeSerial);

                    lista = Array.from(new Set(lista));

                    if (lista.length === 0) {
                        feedbackAlert.className = 'alert alert-warning';
                        feedbackAlert.textContent = 'Nenhum n√∫mero de s√©rie v√°lido encontrado.';
                        feedbackContainer.classList.remove('d-none');
                        return;
                    }

                    console.log("üì¶ [PAYLOAD]:", { seriais: lista, status });

                    submitButton.disabled = true;
                    spinner.classList.remove('d-none');

                    try {
                        const resp = await fetchWithAuth(`${API_BASE}/vestes/bulk-create/`, {
                            method: 'POST',
                            body: JSON.stringify({ seriais: lista, status: status }) // ‚Üê Envia 'status'
                        });

                        if (!resp) return;

                        console.log("üì® [RESPONSE] Status:", resp.status);

                        if (resp.ok) {
                            const data = await resp.json();
                            console.log("üìÑ [RESPONSE] Data:", data);
                            
                            // Mostra feedback por 2 segundos e redireciona
                            feedbackAlert.className = 'alert alert-success';
                            let html = `<p class="mb-2"><strong>${data.mensagem || 'Processamento conclu√≠do.'}</strong></p>`;
                            
                            if (Array.isArray(data.criadas) && data.criadas.length) {
                                html += '<div class="mb-2"><strong class="text-success">‚úì Criadas com sucesso:</strong><ul class="mb-0 mt-1">';
                                data.criadas.forEach(s => html += `<li>${s}</li>`);
                                html += '</ul></div>';
                            }
                            
                            if (Array.isArray(data.ignoradas) && data.ignoradas.length) {
                                html += '<div><strong class="text-warning">‚ö† Ignoradas (j√° existiam):</strong><ul class="mb-0 mt-1">';
                                data.ignoradas.forEach(s => html += `<li>${s}</li>`);
                                html += '</ul></div>';
                            }
                            
                            feedbackAlert.innerHTML = html;
                            feedbackContainer.classList.remove('d-none');
                            
                            // Redireciona ap√≥s 2 segundos
                            console.log("üîÑ [REDIRECT] Redirecionando em 2s...");
                            setTimeout(() => {
                                window.location.href = "/templates/vestes.html";
                            }, 2000);
                        } else {
                            const errorData = await resp.json().catch(() => ({ detail: 'Erro desconhecido' }));
                            console.error("‚ùå [ERROR]:", errorData);
                            
                            let msg = errorData.detail || errorData.erro || JSON.stringify(errorData);
                            
                            if (resp.status === 401) msg = 'N√£o autorizado. Fa√ßa login.';
                            if (resp.status === 403) msg = 'Voc√™ n√£o tem permiss√£o para cadastrar vestes.';
                            
                            feedbackAlert.className = 'alert alert-danger';
                            feedbackAlert.textContent = msg;
                            feedbackContainer.classList.remove('d-none');
                        }
                    } catch (error) {
                        console.error("üí• [EXCEPTION]:", error);
                        feedbackAlert.className = 'alert alert-danger';
                        feedbackAlert.textContent = `Erro de rede: ${error.message}`;
                        feedbackContainer.classList.remove('d-none');
                    } finally {
                        submitButton.disabled = false;
                        spinner.classList.add('d-none');
                    }
                });

                console.log("‚úÖ [READY] Script de vestes pronto!");
            });
        </script>
    </body>
</html>