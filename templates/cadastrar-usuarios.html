<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SafeVest - Cadastrar Novo Usu√°rio</title>

  <!-- Bootstrap e √≠cones -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" rel="stylesheet" />

  <!-- CSS principal -->
  <link rel="stylesheet" href="/static/css/style.css" />
</head>

<body>
  <div class="d-flex" id="wrapper">
    <!-- Sidebar (preenchida dinamicamente por layout.js) -->
    <div id="sidebar-wrapper"></div>

    <!-- Conte√∫do principal -->
    <div id="page-content-wrapper">
      <!-- Navbar -->
      <nav class="d-flex align-items-center justify-content-between bg-danger text-white p-3 shadow-sm">
        <div class="d-flex gap-3 align-items-center">
          <a href="#" class="text-white fs-4" id="menu-toggle">
            <i class="bi bi-list"></i>
          </a>
          <span class="fs-5 fw-bold">Cadastrar Novo Usu√°rio</span>
        </div>
        <a href="/templates/trabalhadores.html" class="btn btn-light btn-sm">
          <i class="bi bi-arrow-left me-1"></i> Voltar
        </a>
      </nav>

      <!-- Main -->
      <main class="container-fluid my-4">
        <div class="row justify-content-center">
          <div class="col-lg-10">
            <div class="card shadow-sm border-0">
              <div class="card-body p-4 p-md-5">
                <h5 class="card-title mb-3">Novo Colaborador</h5>
                <p class="card-text text-muted">
                  Preencha os dados abaixo para criar um novo usu√°rio no sistema.
                </p>

                <form id="form-cadastro-usuario">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <div class="form-floating">
                        <input type="text" class="form-control" id="first_name" placeholder="Nome" required />
                        <label for="first_name">Nome</label>
                      </div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <div class="form-floating">
                        <input type="text" class="form-control" id="last_name" placeholder="Sobrenome" required />
                        <label for="last_name">Sobrenome</label>
                      </div>
                    </div>
                  </div>

                  <!-- Senha e confirma√ß√£o -->
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="password" class="form-label fw-semibold small">Senha Provis√≥ria</label>
                      <div class="input-group">
                        <input type="password" class="form-control" id="password" placeholder="Crie uma senha"
                          required />
                        <span class="input-group-text" id="togglePassword" style="cursor: pointer">
                          <i class="bi bi-eye-slash" id="eyeIcon"></i>
                        </span>
                      </div>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label for="confirm_password" class="form-label fw-semibold small">Confirmar Senha</label>
                      <div class="input-group">
                        <input type="password" class="form-control" id="confirm_password" placeholder="Repita a senha"
                          required />
                        <span class="input-group-text" id="toggleConfirmPassword" style="cursor: pointer">
                          <i class="bi bi-eye-slash" id="eyeIconConfirm"></i>
                        </span>
                      </div>
                    </div>
                  </div>

                  <!-- Fun√ß√£o e Email -->
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <div class="form-floating">
                        <select class="form-select" id="funcao" required>
                          <option value="" disabled selected>
                            Selecione a fun√ß√£o...
                          </option>
                          <option value="Administrador">Administrador</option>
                          <option value="Supervisor">Supervisor</option>
                          <option value="Operador">Operador</option>
                        </select>
                        <label for="funcao">Fun√ß√£o</label>
                      </div>
                    </div>

                    <div class="col-md-6 mb-3">
                      <div class="form-floating">
                        <input type="email" class="form-control" id="email" placeholder="Email (login do colaborador)"
                          required />
                        <label for="email">Email (login do colaborador)</label>
                      </div>
                    </div>
                  </div>

                  <!-- Feedback -->
                  <div id="feedback-alert" class="alert d-none mt-3" role="alert"></div>

                  <!-- Bot√£o -->
                  <div class="d-flex justify-content-center mt-4">
                    <button type="submit"
                      class="btn btn-danger d-inline-flex align-items-center justify-content-center gap-2"
                      style="min-width: 150px">
                      <span class="button-text">Criar Usu√°rio</span>
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- JS Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Layout Script -->
  <script src="/static/js/layout.js"></script>

  <!-- Script de Cadastro INLINE (tempor√°rio at√© acertar o caminho) -->
  <script>
    console.log("üü¢ [INIT] Script cadastro inline carregado");

    document.addEventListener("DOMContentLoaded", () => {
      console.log("üü¢ [DOM] DOMContentLoaded disparado");

      const form = document.getElementById("form-cadastro-usuario");
      const feedback = document.getElementById("feedback-alert");
      const submitBtn = form.querySelector("button[type='submit']");
      const btnTextSpan = submitBtn.querySelector(".button-text");

      const API_BASE = "http://127.0.0.1:8000/api";
      const ENDPOINT = `${API_BASE}/usuarios/create/`;

      console.log("üü¢ [CONFIG] Endpoint:", ENDPOINT);

      // Utilit√°rios
      function showAlert(message, type = "warning") {
        console.log(`üì¢ [ALERT] ${type.toUpperCase()}:`, message);
        feedback.textContent = message;
        feedback.className = `alert alert-${type} mt-3`;
        feedback.classList.remove("d-none");
        feedback.style.display = "block";
      }

      function hideAlert() {
        feedback.classList.add("d-none");
        feedback.style.display = "none";
      }

      function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }

      function validatePassword(pw) {
        return typeof pw === "string" && pw.length >= 8;
      }

      // Autentica√ß√£o
      function getTokens() {
        return {
          access: localStorage.getItem("accessToken"),
          refresh: localStorage.getItem("refreshToken"),
        };
      }

      function logout() {
        localStorage.removeItem("accessToken");
        localStorage.removeItem("refreshToken");
        window.location.href = "/templates/login.html";
      }

      async function refreshToken() {
        const { refresh } = getTokens();
        if (!refresh) return false;

        try {
          const resp = await fetch(`${API_BASE}/token/refresh/`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ refresh }),
          });

          if (!resp.ok) return false;

          const data = await resp.json();
          localStorage.setItem("accessToken", data.access);
          console.log("üîÑ [AUTH] Token renovado");
          return true;
        } catch (err) {
          console.error("‚ùå [AUTH] Erro ao renovar token:", err);
          return false;
        }
      }

      async function fetchWithAuth(url, options = {}, retry = true) {
        const { access } = getTokens();

        if (!access) {
          console.error("‚ùå [AUTH] Token n√£o encontrado!");
          showAlert("Sess√£o expirada. Fa√ßa login novamente.", "danger");
          setTimeout(() => logout(), 1500);
          return null;
        }

        console.log("üîë [AUTH] Token encontrado:", access.substring(0, 20) + "...");

        const headers = {
          "Content-Type": "application/json",
          Authorization: `Bearer ${access}`,
          ...options.headers,
        };

        try {
          const resp = await fetch(url, { ...options, headers });

          if (resp.status === 401 && retry) {
            console.warn("‚ö†Ô∏è [AUTH] Token expirado, tentando renovar...");
            const renovado = await refreshToken();
            if (renovado) return fetchWithAuth(url, options, false);
            logout();
            return null;
          }

          return resp;
        } catch (err) {
          console.error("üí• [FETCH] Erro de rede:", err);
          throw err;
        }
      }

      // Toggle senha
      const togglePassword = document.getElementById("togglePassword");
      const passwordInput = document.getElementById("password");
      const eyeIcon = document.getElementById("eyeIcon");

      const toggleConfirmPassword = document.getElementById("toggleConfirmPassword");
      const confirmPasswordInput = document.getElementById("confirm_password");
      const eyeIconConfirm = document.getElementById("eyeIconConfirm");

      togglePassword?.addEventListener("click", () => {
        const type = passwordInput.type === "password" ? "text" : "password";
        passwordInput.type = type;
        eyeIcon.classList.toggle("bi-eye");
        eyeIcon.classList.toggle("bi-eye-slash");
      });

      toggleConfirmPassword?.addEventListener("click", () => {
        const type = confirmPasswordInput.type === "password" ? "text" : "password";
        confirmPasswordInput.type = type;
        eyeIconConfirm.classList.toggle("bi-eye");
        eyeIconConfirm.classList.toggle("bi-eye-slash");
      });

      // Submit
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log("üöÄ [SUBMIT] Formul√°rio enviado!");
        hideAlert();

        const firstName = document.getElementById("first_name").value.trim();
        const lastName = document.getElementById("last_name").value.trim();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        const confirmPassword = document.getElementById("confirm_password").value;
        const funcao = document.getElementById("funcao").value;

        console.log("üìù [FORM] Dados:", { firstName, lastName, email, funcao });

        if (!firstName) return showAlert("Informe o nome.", "warning");
        if (!lastName) return showAlert("Informe o sobrenome.", "warning");
        if (!validateEmail(email)) return showAlert("Email inv√°lido.", "warning");
        if (!funcao) return showAlert("Selecione uma fun√ß√£o.", "warning");
        if (password !== confirmPassword) return showAlert("Senhas n√£o conferem.", "danger");
        if (!validatePassword(password)) return showAlert("Senha muito curta (m√≠nimo 8 caracteres).", "warning");

        console.log("‚úÖ [VALIDA√á√ÉO] OK!");

        submitBtn.disabled = true;
        const originalText = btnTextSpan?.textContent || submitBtn.textContent;
        if (btnTextSpan) btnTextSpan.textContent = "Criando...";

        const payload = {
          first_name: firstName,
          last_name: lastName,
          email,
          password,
          grupo: funcao,
        };

        console.log("üì¶ [PAYLOAD]:", JSON.stringify(payload, null, 2));

        try {
          const resp = await fetchWithAuth(ENDPOINT, {
            method: "POST",
            body: JSON.stringify(payload),
          });

          if (!resp) return;

          console.log("üì® [RESPONSE] Status:", resp.status);

          const contentType = resp.headers.get("content-type");
          let responseData;

          if (contentType?.includes("application/json")) {
            responseData = await resp.json();
            console.log("üìÑ [RESPONSE] Data:", responseData);
          } else {
            const text = await resp.text();
            console.log("üìÑ [RESPONSE] Text:", text);
            responseData = { mensagem: text };
          }

          if (resp.ok) {
            console.log("‚úÖ [SUCCESS] Usu√°rio criado!");
            showAlert(responseData.mensagem || "Usu√°rio criado com sucesso!", "success");
            form.reset();
            setTimeout(() => window.location.href = "/templates/trabalhadores.html", 2000);
          } else {
            console.error("‚ùå [ERROR]:", responseData);
            let msg = responseData.erro || responseData.mensagem || responseData.detail || "Erro desconhecido";

            if (resp.status === 400 && typeof responseData === "object") {
              const erros = [];
              for (const [campo, mensagens] of Object.entries(responseData)) {
                if (Array.isArray(mensagens)) {
                  erros.push(`${campo}: ${mensagens.join(", ")}`);
                } else if (typeof mensagens === "string") {
                  erros.push(`${campo}: ${mensagens}`);
                }
              }
              if (erros.length > 0) msg = "Erros:\n" + erros.join("\n");
            }

            if (resp.status === 403) msg = "Apenas administradores podem criar usu√°rios.";
            if (resp.status === 401) {
              msg = "Sess√£o expirada.";
              setTimeout(() => logout(), 1500);
            }

            showAlert(msg, "danger");
          }
        } catch (error) {
          console.error("üí• [EXCEPTION]:", error);
          showAlert("Erro de rede: " + error.message, "danger");
        } finally {
          submitBtn.disabled = false;
          if (btnTextSpan) btnTextSpan.textContent = originalText;
        }
      });

      console.log("‚úÖ [READY] Script pronto!");
    });
  </script>

  <script>
    console.log("üß† [SafeVest] P√°gina de cadastro carregada corretamente.");
  </script>
</body>

</html>